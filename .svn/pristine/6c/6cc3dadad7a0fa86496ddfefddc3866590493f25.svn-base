<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
    <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

        <script src='${cPath }/resources/js/dist/index.global.js'></script>
        <script src='${cPath }/resources/js/dist/ko.global.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <style>
            .fc-icon-chevron-right:before {
                content: "";
            }

            .fc-icon-chevron-left:before {
                content: "";
            }

            html,
            body {
                margin: 0;
                padding: 0;
                font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
                font-size: 14px;
            }

            #calendar-container {
                position: relative;
                z-index: 1;
            }

            #calendar {
                max-width: 1100px;
                margin: 20px auto;
            }

            .modal {
                position: fixed;
                width: 100%;
                /* fixedì¼ ë•ŒëŠ” height:100% ë™ì‘ */
                height: 100%;
                left: 0px;
                top: 0px;
                background-color: rgba(0, 0, 0, 0.274);
                /* ë¬´ì¡°ê±´ í¬ê²¡! */
                z-index: 314;
                display: none;
            }

            .detailModal {
                position: fixed;
                width: 100%;
                /* fixedì¼ ë•ŒëŠ” height:100% ë™ì‘ */
                height: 100%;
                left: 0px;
                top: 0px;
                background-color: rgba(0, 0, 0, 0.274);
                /* ë¬´ì¡°ê±´ í¬ê²¡! */
                z-index: 315;
                display: none;
            }


            .modalCont {
                width: 400px;
                height: 260px;
                /* ìˆ˜í‰ ê°€ìš´ë° ì •ë ¬ */
                margin-top: 15%;
                margin-left: 38%;
                padding-left: 20px;
                border-radius: 5%;
                background-color: rgb(255, 255, 255);
                color: rgb(9, 9, 8);
            }

            .detailModalCont {
                width: 400px;
                height: 300px;
                /* ìˆ˜í‰ ê°€ìš´ë° ì •ë ¬ */
                margin-top: 15%;
                margin-left: 38%;
                padding-left: 20px;
                border-radius: 5%;
                background-color: rgb(255, 255, 255);
                color: rgb(9, 9, 8);
            }

            .modalSubmit {
                margin-left: 230px;
            }

            .modalInput {
                width: 250px;
                height: 40px;
                font-size: 15px;
                border: 0;
                border-radius: 15px;
                outline: none;
                padding-left: 10px;
                background-color: rgb(233, 233, 233);
            }

            .calendarCenter {
                margin: 0 auto;
            }

            /* IE */
            select::-ms-expand {
                display: none;
            }

            .select {
                width: 150px;
                height: 35px;
                background: url('https://freepikpsd.com/media/2019/10/down-arrow-icon-png-7-Transparent-Images.png') calc(100% - 5px) center no-repeat;
                background-size: 20px;
                padding: 5px 30px 5px 10px;
                border-radius: 4px;
                outline: 0 none;
            }

            .select option {
                background: black;
                color: #fff;
                padding: 3px 0;
            }

            .card {
                border-radius: 15px;
            }

            .card-header h5 {
                color: gray;
            }

            .table {
                text-align: center;
                vertical-align: middle;
                font-size: 9px;
            }

            .table thead {
                background-color: #405189c7;
                color: white;
            }
        </style>

        <script>
            let calendar = null;



            $(function () {
                const Calendar = FullCalendar.Calendar; // ìº˜ë¦°ë” api ìƒì„±í•˜ê¸°

                const calendarEl = document.getElementById('calendar'); // bodyì— ìº˜ë¦°ë” ë„£ì„ ë¶€ë¶„ íƒœê·¸ì„ íƒ

                calendar = new Calendar(calendarEl, {
                    selectable: true,
                    selectHelper: true,
                    select: function (res) {
                        console.log("selectí–ˆì„ë•Œ ë¨¸ê°€ì˜¤ëŠ”ì§€ ì²´í‚", res)
                        modal.show()
                    },
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: '${cPath}/reserveList'  // url ì„œë¸”ë¦¿ ì£¼ì†Œ ì¨ì£¼ë©´ ë¨!
                    ,
                    editable: true, // í¸ì§‘ê°€ëŠ¥

                    locale: 'ko', // í•œêµ­ì–´
                    eventDrop: function (info) {    // ë“œë˜ê·¸í•´ì„œ ìœ„ì¹˜ ì§€ì •í•˜ë©´ ë‚ ì§œ ìˆ˜ì •
                        let id = info.event.id;
                        let title = info.event.title;
                        let start = info.event.start.toISOString().substr(0, 10);
                        $.ajax({
                            url: "",
                            type: "post",
                            data: { id: id, title: title, start: start },
                            success: function () {
                                alert("ì¼ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ")
                            }
                        })
                    },
                    // ì¼ì • í´ë¦­í•˜ë©´ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ë¡œ ë³´ì—¬ì£¼ê¸°
                    eventClick: function (info) {
                        console.log(info.event.title)
                        $("#scheduleKey").val(info.event.id);
                        $("#patientName").val(info.event.title);
                        $("#bedNum").val(info.event.extendedProps.bed)
                        $("#charger").val(info.event.extendedProps.charger)
                        /*
                        $.ajax({
                            url: "",
                            type: "post",
                            data: {
                                id: id
                            },
                            success: function (res) {
                            }
                        })
                        */
                        detailModal.show();
                    }

                });
                calendar.render();
            });


        </script>

        <div class="grid-stack"> <!-- ê·¸ë¦¬ë“œìŠ¤íƒ ê³µê°„ -->

            <div class="grid-stack-item card" gs-x="0" gs-y="0" gs-w="2" gs-h="2"> <!-- grid-stack-itemì„ ì ì–´ì•¼ ì ìš©ë¨ -->
                <div class="grid-stack-item-content">
                    <div class="card-header">
                        <h5>ì…ì› ëŒ€ê¸° í™˜ì ëª©ë¡</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>ì½”ë“œ</th>
                                    <th>í™˜ìëª…</th>
                                    <th>í¬ë§ë“±ê¸‰</th>
                                    <th>ë³‘ì‹¤ë°°ì •</th>
                                </tr>
                            </thead>
                            <tbody id="waitingPatientList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid-stack-item card" gs-x="2" gs-y="" gs-w="2" gs-h="2"> <!-- grid-stack-itemì„ ì ì–´ì•¼ ì ìš©ë¨ -->
                <div class="grid-stack-item-content">
                    <div class="card-header">
                        <h5>ìˆ˜ìˆ  ëŒ€ê¸° í™˜ì ëª©ë¡</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>ì½”ë“œ</th>
                                    <th>í™˜ìëª…</th>
                                </tr>
                            </thead>
                            <tbody id="waitingSurgeryList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <div class="grid-stack-item card" gs-x="4" gs-y="0" gs-w="4" gs-h="5">
                <div class="grid-stack-item-content">
                    <div class="card-header">
                        <h5>ë³‘ë™ ë°°ì¹˜ ìƒí™©</h5>
                    </div>
                    <div class="card-body" id="wardStatus">

                        <span></span>
                        <table class="table table-bordered">
                            <thead>

                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                        <br>

                        <span></span>
                        <table class="table table-bordered">
                            <thead>

                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                        <br>

                        <span></span>
                        <table class="table table-bordered">
                            <thead>

                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                        <br>

                        <span></span>
                        <table class="table table-bordered">
                            <thead>

                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid-stack-item card" gs-x="8" gs-y="0" gs-w="4" gs-h="5" gs-no-resize="true" gs-no-move="true"
                gs-locked="true"> <!-- grid-stack-itemì„ ì ì–´ì•¼ ì ìš©ë¨ -->
                <div class="grid-stack-item-content">
                    <div class="card-header">
                        <h5>ìˆ˜ìˆ  ì¼ì •</h5>
                    </div>
                    <div class="card-body" id='calendar'>
                    </div>
                </div>
            </div>

            

        <!-- ëª¨ë‹¬ ------------------------------------------------------------------------------------------------------------------------------->

        <!-- ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ë‚˜ì˜¤ëŠ” ëª¨ë‹¬ -->
        <div id="modal" class="modal">
            <div id="modalCont" class="modalCont">
                <br> <br>
                ë‹´ë‹¹ì : <input id="modalInput" class="modalInput" type="text" value="${authEmp.empName}" disabled><br>
                <br>
                í™˜ìë²ˆí˜¸ :
                <select id="patientName" class="select">
                    <option disabled selected>í™˜ìì´ë¦„ ğŸš‘</option>
                    <option value="apple">apple</option>
                    <option value="orange">orange</option>
                    <option value="grape">grape</option>
                    <option value="melon">melon</option>
                </select><br> <br>
                ì¹¨ìƒë²ˆí˜¸ : <input id="modalInput" class="modalInput" type="text" placeholder="ì¹¨ìƒë²ˆí˜¸">
                <br> <br>
                <button id="modalSubmit" class="modalSubmit" onclick="allSave()">ë“±ë¡í•˜ê¸°</button>
                <button id="modalButton" onclick="modalClose()">X</button>
            </div>
        </div>

        <!-- ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚˜ì˜¤ëŠ” ëª¨ë‹¬ -->
        <div id="detailModal" class="detailModal">
            <div id="detailModalCont" class="detailModalCont">
                <br>
                ìŠ¤ì¼€ì¤„ ë²ˆí˜¸ : <input id="scheduleKey" class="modalInput" type="text">
                <br><br>
                í™˜ìëª… : <input id="patientName" class="modalInput" type="text">
                <br><br>
                ì¹¨ëŒ€ë²ˆí˜¸ : <input id="bedNum" class="modalInput" type="text">
                <br><br>
                ë‹´ë‹¹ì : <input id="charger" class="modalInput" type="text">
                <br> <br>
                <button class="modalSubmit" onclick="modify()">ìˆ˜ì •í•˜ê¸°</button>
                <button onclick="detailModalClose()">X</button>
            </div>
        </div>



        <script>

            const modal = $('#modal')
            const modalClose = () => {
                modal.hide();
            }
            const detailModal = $('.detailModal')
            const detailModalClose = () => {
                detailModal.hide();
            }

            // ë“±ê¸‰ ì •ë³´
            if (!localStorage.getItem('gradeList')) {
                getGradeList();
            }

            // ë“±ê¸‰ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
            function getGradeList() {
                $.ajax({
                    url: "${cPath}/reservation/gradeList",
                    method: "get",
                    dataType: "json",
                    success: (resp) => {
                        localStorage.setItem('gradeList', JSON.stringify(resp));
                    }
                })
            }

            // ì…ì› ëŒ€ê¸° í™˜ì ëª©ë¡ tbody selected
            let waitingPatientList = $('#waitingPatientList');

            // í¬ë§ ë“±ê¸‰ ë³€ë™ì‹œ í˜¸ì¶œ ë©”ì„œë“œ
            waitingPatientList.on('change', '.graddSelect', function () {
                console.log("ë°”ê¼ˆìŠˆ");
                let selectedGrade = $(this).find('option:selected').val();
                let patientInfo = $(this).parents('tr').data("patientInfo")
                console.log("Data", patientInfo);
                let data = {
                    waitingKey: patientInfo.waitingKey
                    , wardGrade: selectedGrade
                }
                $.ajax({
                    url: "${cPath}/reservation/wardGrade",
                    method: "patch",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    dataType: "json",
                    beforeSend: function (xhr) {   /*ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ì „ì— í—¤ë”ì— csrfê°’ì„ ì„¤ì •í•œë‹¤*/
                        xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
                    },
                    success: (resp) => {
                        console.log(resp);
                    }
                })
            });

            let selectedPatientInfo = null;

            // ë°°ì¹˜ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ
            waitingPatientList.on('click', '.assignBtn', function () {
                console.log("ë°°ì¹˜ë²„íŠ¼ ëˆŒë €ìŠˆ! í•´ë‹¹ í™˜ì ì •ë³´ ì €ì¥í•´ìœ ~");
                selectedPatientInfo = $(this).parents('tr').data("patientInfo")
            })





            // ëŒ€ê¸° í™˜ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            function getWaitingPatientList() {
                let gradeList = JSON.parse(localStorage.getItem('gradeList'));

                $.ajax({
                    url: "${cPath}/reservation/waitingPatientList",
                    method: "get",
                    dataType: "json",
                    success: (resp) => {
                        console.log("ëŒ€ê¸° í™˜ì ëª©ë¡ ë°ì´í„° ì²´í‚", resp);
                        waitingPatientList.empty();
                        $.each(resp, function (i, patient) {
                           
                            let patientWardGrade = patient.wardGrade;
                            let options = [];
                            let stOption = $('<option>').html("ì„ íƒ").val("");
                            options.push(stOption);
                           
                            $.each(gradeList, function (i, grade) {
                                let option = $('<option>').val(grade.code).html(grade.codeName);
                                if (patientWardGrade == grade.code) {
                                    option.attr("selected", "selected");
                                }

                                options.push(option);
                            });

                            let select = $('<select>').append(options).addClass('form-select-sm').addClass("graddSelect");
                            let button = $('<button>').text("ë°°ì •").addClass("btn btn-primary").addClass("assignBtn");
                            let tr = $('<tr>').append(
                                $('<td>').html(patient.patientKey)
                                , $('<td>').html(patient.patientName)
                                , $('<td>').html(select)
                                , $('<td>').html(button)
                            ).data("patientInfo", patient);
                            //             <td><select class='hopeGrade'></td>
                            //             <td><input type='button' class='btn btn-primary' value='ë°°ì •' /></td>`
                            waitingPatientList.append(tr);
                        });
                    }
                });
            }
            getWaitingPatientList();


            // ë³‘ë™ ìƒíƒœ ë„£ì„ tbody selected
            let wardStatus = $('#wardStatus');

            // í˜¸ì‹¤ ë„£ì„ span ë¶€ë¶„ selected
            let wardStatusSpans = wardStatus.find('span');

            // ë¹„ì–´ìˆëŠ” ì¹¨ìƒ ì„ íƒì‹œ ë°œìƒ ë©”ì„œë“œ 
            let wardStatusTables = wardStatus.find('table').on('click', '.usableWard', function () {
                console.log("í´ë¦­ì´ë²¤íŠ¸ í™•ì¸~")
                let selectedBedInfo = $(this).data("wardInfo");
                if (selectedPatientInfo == null) {
                    // í™˜ì ì„ íƒ ì—†ì´ ì„ íƒ ê²½ìš°ì—ëŠ” ê·¸ëƒ¥ return
                    return;
                }

                let data = {
                    patientKey: selectedPatientInfo.patientKey
                    , wardBedKey: selectedBedInfo.wardBedKey
                    , waitingKey: selectedPatientInfo.waitingKey
                }

                // ë°°ì • ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë‚˜ì„œ + ë²„íŠ¼ ëˆ„ë¥´ë©´ ë°°ì •í•˜ëŠ” ê²ƒì´ë¯€ë¡œ ajax ì‹¤í–‰ 
                $.ajax({
                    url: "${cPath}/reservation/hospitalizationRecord"
                    , method: "POST"
                    , data: JSON.stringify(data)
                    , contentType: "application/json"
                    , beforeSend: function (xhr) {   /*ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ì „ì— í—¤ë”ì— csrfê°’ì„ ì„¤ì •í•œë‹¤*/
                        xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
                    }
                    , success: () => {
                        getWardStatus();
                        getWaitingPatientList();
                    }
                    , error: () => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong!',
                            footer: '<a href="">Why do I have this issue?</a>'
                        })
                    }
                })

                // ì„ íƒ ì •ë³´ ì´ˆê¸°í™”
                selectedPatientInfo = null;
                console.log("ì´ˆê¸°í™” ë˜ëŠ”ì§€ ì²´í‚", selectedPatientInfo);
            });






            // 

            // ë³‘ë™ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
            function getWardStatus() {
                $.ajax({
                    url: "${cPath}/reservation/wardBedStatus",
                    method: "get",
                    dataType: "json",
                    success: (resp) => {
                        console.log("ì›ë³¸ë°ì´í„°", resp);

                        let groupedData = resp.reduce((acc, obj) => {
                            const key = obj.wardKey;
                            if (!acc[key]) {
                                acc[key] = [];
                            }
                            acc[key].push(obj);
                            return acc;
                        }, {});

                        console.log("ê°€ê³µë°ì´í„°", groupedData);

                        let index = 0;
                        $.each(groupedData, function (i, ward) {
                            wardStatusSpans.eq(index).text(`\${i}í˜¸ (\${ward[0].wardGrade})`);

                            let theadTr = $('<tr>');
                            let tbodyTr = $('<tr>');
                            $.each(ward, function (j, bed) {
                                let th = $('<th>').html(`\${j+1}ë²ˆ ì¹¨ìƒ`);
                                let td = $('<td>');
                                td.data("wardInfo", bed);
                                if (bed.patientName == null) {
                                    td.html("+").addClass("usableWard");
                                } else {
                                    td.html(`\${bed.patientName} [ ~\${bed.expectedCheckOutDate} ]`);
                                }
                                theadTr.append(th);
                                tbodyTr.append(td);
                            });
                            wardStatusTables.eq(index).find("thead").empty().append(theadTr);
                            wardStatusTables.eq(index).find("tbody").empty().append(tbodyTr);
                            index++;
                        });
                    }
                });
            }
            getWardStatus();




            // ëª¨ë‹¬ì°½ì—ì„œ ì¼ì • ìˆ˜ì •í•˜ê¸°
            const modify = () => {
                let scheduleId = $("#scheduleKey").val();
                let bedNum = $("#bedNum").val();
                let charger = $("#charger").val();
                let sendData = {}
                sendData = {
                    "scheduleKey": scheduleId, "wardBedKey": bedNum, "appintmentCharger": charger
                }
                $.ajax({
                    url: "${cPath}/scheduleUpdate",
                    type: "post",
                    data: JSON.stringify(sendData),
                    contentType: "application/json",
                    beforeSend: function (xhr) {   /*ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ì „ì— í—¤ë”ì— csrfê°’ì„ ì„¤ì •í•œë‹¤*/
                        xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
                    },
                    success: function (res) {
                        calendar.refetchEvents();
                        calendar.render();
                        detailModal.hide();
                    },
                    error: function (request, status, error) {
                        alert("ìƒíƒœì½”ë“œ:" + request.status + "\n" + "ì—ëŸ¬ë‚´ìš©:" + request.responseText + "\n" + "error:" + error);
                    }
                })
            }



            // ëª¨ë‹¬ì°½ì—ì„œ ì‚­ì œ ëˆŒë €ì„ ë•Œ ì•„ì§ ì•ˆë§Œë“¦
            const deleteEvent = (id) => {
                $.ajax({
                    url: "",
                    type: "post",
                    data: {
                        id: id
                    },
                    success: function (res) {
                        alert("ì„±ê³µ ì‚­ì œ")
                    },
                    error: function (request, status, error) {
                        alert("ìƒíƒœì½”ë“œ:" + request.status + "\n" + "ì—ëŸ¬ë‚´ìš©:" + request.responseText + "\n" + "error:" + error);
                    }
                })
            }

            const createOption = () => {
                // ì˜¤ë”ëª©ë¡ì— ì´ë¦„ì´ ìˆëŠ” í™˜ì ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                    url: "",
                    type: "get",
                    dataType: "json",
                    success: function (res) {

                    },
                    error: function (request, status, error) {
                        alert("ìƒíƒœì½”ë“œ:" + request.status + "\n" + "ì—ëŸ¬ë‚´ìš©:" + request.responseText + "\n" + "error:" + error);
                    }
                })
            }
        </script>
        <!-- ëª¨ë‹¬ ------------------------------------------------------------------------------------------------------------------------------->


        <script>
            // ê·¸ë¦¬ë“œìŠ¤íƒ ê¸°ë³¸ì„¤ì •
            var grid = GridStack.init({});

        </script>